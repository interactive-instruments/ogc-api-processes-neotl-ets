import "../1_Core/4_Processes/Processes-tcs.neotl"
import "../../shared/Assertions.neotl"

TestCase "Process descriptions" {
    
    // /conf/core/process
    // /conf/core/process-success
    // /conf/ogc-process-description/json-encoding
    // /conf/ogc-process-description/inputs-def
    // /conf/ogc-process-description/input-mixed-type
    // /conf/ogc-process-description/outputs-def
    // /conf/ogc-process-description/output-def
    // /conf/ogc-process-description/output-mixed-type

    id: encoding.json
    description: "Validate that a process description can be retrieved from the expected location."

    references:
        - "Processes /processes"
            "https://docs.ogc.org/DRAFTS/18-062.html#_processes_processes"
            AbstractTestCase

    ValidationStep "Generate Requests" {
        id: generate
        description: "Generate Process Description Requests"

        given:
            - Response from process.list.encoding.json
        when: Generator generators.process.ids executed
        then:
            - Assert JSON { 
                ${processIds} not empty
                otherwise FAIL with "No IDs in process list found"
             }
    }


    ValidationStep "Validate Process Description" {
        id: core1ProcessesTc3Step2
        description: "Validated responses of the generated process descriptions requests"

        given:
            - One ${processId} of ${processIds} from generate
        when: Request requests.processes.description executed
        then:
            - AssertionGroup assertions.json.success must pass
            - Assert OpenAPI3 {
                schema
                "${schemaUrl}/process.yaml"
                validates
            }
            - Assert JSON {
                $.id equals ${processId}
                otherwise FAIL with 
                "The id in the returned response does not match the requested id"
            }
    }
}

Generator "Generate Process IDs" {
    id: generators.process.ids

    from RESPONSE
        as ${processIds} query $..id
}

GetRequest "Get Process Description" {
    id: requests.processes.description

    path: "processes/${processId}"

    headers:
        - "Accept" = "application/json"
}